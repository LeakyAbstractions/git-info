#!/bin/bash

#
# Extracts information from the GIT repository and generates a header file
#
# version   0.1.0.0
# author    Copyright (c) 2018 Guillermo Calvo
#
GENERATED_FILE=${1:-deps/git-info.h}

#
# Extracts information
#
echo "Extracting info from GIT repository..."
GENERATION_DATE=`                   date -Iminute`
GIT_INFO_ORIGIN=`                   git remote get-url origin 2>/dev/null`
GIT_INFO_BRANCH=`                   git symbolic-ref --short HEAD 2>/dev/null`
GIT_INFO_HASH=`                     git log -1 --format=%H 2>/dev/null`
GIT_INFO_TAG=`                      git log -1 --format=%d 2>/dev/null | grep -oP '(?<=tag\: )(.+?)(?=[,\)])' | head -n1`
GIT_INFO_SUBJECT=`                  git log -1 --format=%s 2>/dev/null | tr "\42" "'" | tr "\134" "/"`
GIT_INFO_BODY=`                     git log -1 --format=%b 2>/dev/null | tr "\42" "'" | tr "\134" "/" | sed 's/^/    "/' | sed 's/$/\\\\n" \\\\/' | sed 's/"\\\\n" //'`
GIT_INFO_NOTES=`                    git log -1 --format=%N 2>/dev/null | tr "\42" "'" | tr "\134" "/" | sed 's/^/    "/' | sed 's/$/\\\\n" \\\\/' | sed 's/"\\\\n" //'`
GIT_INFO_AUTHOR_NAME=`              git log -1 --format=%an 2>/dev/null`
GIT_INFO_AUTHOR_EMAIL=`             git log -1 --format=%ae 2>/dev/null`
GIT_INFO_AUTHOR_TIMESTAMP=`         git log -1 --format=%at 2>/dev/null`
GIT_INFO_AUTHOR_DATE=`              git log -1 --format=%ai 2>/dev/null`
GIT_INFO_AUTHOR_DATE_RFC2822=`      git log -1 --format=%aD 2>/dev/null`
GIT_INFO_AUTHOR_DATE_ISO8601=`      git log -1 --format=%aI 2>/dev/null`
GIT_INFO_COMMITTER_NAME=`           git log -1 --format=%cn 2>/dev/null`
GIT_INFO_COMMITTER_EMAIL=`          git log -1 --format=%ce 2>/dev/null`
GIT_INFO_COMMITTER_TIMESTAMP=`      git log -1 --format=%ct 2>/dev/null`
GIT_INFO_COMMITTER_DATE=`           git log -1 --format=%ci 2>/dev/null`
GIT_INFO_COMMITTER_DATE_RFC2822=`   git log -1 --format=%cD 2>/dev/null`
GIT_INFO_COMMITTER_DATE_ISO8601=`   git log -1 --format=%cI 2>/dev/null`

#
# Generates file
#
echo "Generating file: $GENERATED_FILE"
mkdir -p `dirname $GENERATED_FILE`
cat > $GENERATED_FILE <<- EOF
#ifndef GIT_INFO_H
#define GIT_INFO_H

/*
 * This file was auto-generated on: $GENERATION_DATE
 * by: $0
 * DO NOT EDIT THIS FILE DIRECTLY
 */

#define GIT_INFO_ORIGIN                 "$GIT_INFO_ORIGIN"
#define GIT_INFO_BRANCH                 "$GIT_INFO_BRANCH"
#define GIT_INFO_HASH                   "$GIT_INFO_HASH"
#define GIT_INFO_TAG                    "$GIT_INFO_TAG"
#define GIT_INFO_SUBJECT                "$GIT_INFO_SUBJECT"
#define GIT_INFO_BODY                   \\
$GIT_INFO_BODY
    ""
#define GIT_INFO_NOTES                  \\
$GIT_INFO_NOTES
    ""
#define GIT_INFO_AUTHOR_NAME            "$GIT_INFO_AUTHOR_NAME"
#define GIT_INFO_AUTHOR_EMAIL           "$GIT_INFO_AUTHOR_EMAIL"
#define GIT_INFO_AUTHOR_TIMESTAMP       "$GIT_INFO_AUTHOR_TIMESTAMP"
#define GIT_INFO_AUTHOR_DATE            "$GIT_INFO_AUTHOR_DATE"
#define GIT_INFO_AUTHOR_DATE_RFC2822    "$GIT_INFO_AUTHOR_DATE_RFC2822"
#define GIT_INFO_AUTHOR_DATE_ISO8601    "$GIT_INFO_AUTHOR_DATE_ISO8601"
#define GIT_INFO_COMMITTER_NAME         "$GIT_INFO_COMMITTER_NAME"
#define GIT_INFO_COMMITTER_EMAIL        "$GIT_INFO_COMMITTER_EMAIL"
#define GIT_INFO_COMMITTER_TIMESTAMP    $GIT_INFO_COMMITTER_TIMESTAMP
#define GIT_INFO_COMMITTER_DATE         "$GIT_INFO_COMMITTER_DATE"
#define GIT_INFO_COMMITTER_DATE_RFC2822 "$GIT_INFO_COMMITTER_DATE_RFC2822"
#define GIT_INFO_COMMITTER_DATE_ISO8601 "$GIT_INFO_COMMITTER_DATE_ISO8601"

#endif
EOF

if [ ! -f $GENERATED_FILE ]; then
    >&2 echo -e "\033[0;31mError: Could not generate $GENERATED_FILE\033[0m"
    exit 1;
fi

echo -e "\033[1;34m"
echo "    GIT_INFO_ORIGIN:  $GIT_INFO_ORIGIN"
echo "    GIT_INFO_BRANCH:  $GIT_INFO_BRANCH"
echo "    GIT_INFO_HASH:    $GIT_INFO_HASH"
echo "    GIT_INFO_TAG:     $GIT_INFO_TAG"
echo "    GIT_INFO_SUBJECT: $GIT_INFO_SUBJECT"
echo -e "\033[0m"
